kind: pipeline
name: default


steps:
  - name: prepare
    image: ubuntu
    depends_on: [ clone ]
    volumes:
      - name: reports
        path: /var/local/drone/reports
    commands:
      - mkdir --parents /var/local/drone/reports/${DRONE_REPO}/${DRONE_BUILD_NUMBER}
      - echo "DRONE_BRANCH ${DRONE_BRANCH}\n
      DRONE_BUILD_CREATED ${DRONE_BUILD_CREATED}\n
      DRONE_BUILD_EVENT ${DRONE_BUILD_EVENT}\n
      DRONE_BUILD_NUMBER ${DRONE_BUILD_NUMBER}\n
      DRONE_BUILD_STARTED ${DRONE_BUILD_STARTED}\n
      DRONE_COMMIT_AFTER ${DRONE_COMMIT_AFTER}\n
      DRONE_COMMIT_AUTHOR ${DRONE_COMMIT_AUTHOR}\n
      DRONE_COMMIT_AUTHOR_AVATAR ${DRONE_COMMIT_AUTHOR_AVATAR}\n
      DRONE_COMMIT_AUTHOR_EMAIL ${DRONE_COMMIT_AUTHOR_EMAIL}\n
      DRONE_COMMIT_AUTHOR_NAME ${DRONE_COMMIT_AUTHOR_NAME}\n
      DRONE_COMMIT_BEFORE ${DRONE_COMMIT_BEFORE}\n
      DRONE_COMMIT_BRANCH ${DRONE_COMMIT_BRANCH}\n
      DRONE_COMMIT_LINK ${DRONE_COMMIT_LINK}\n
      DRONE_COMMIT ${DRONE_COMMIT}\n
      DRONE_COMMIT_MESSAGE ${DRONE_COMMIT_MESSAGE}\n
      DRONE_COMMIT_REF ${DRONE_COMMIT_REF}\n
      DRONE_COMMIT_SHA ${DRONE_COMMIT_SHA}\n
      DRONE_GIT_HTTP_URL ${DRONE_GIT_HTTP_URL}\n
      DRONE_GIT_SSH_URL ${DRONE_GIT_SSH_URL}\n
      DRONE_MACHINE ${DRONE_MACHINE}\n
      DRONE_PULL_REQUEST ${DRONE_PULL_REQUEST}\n
      DRONE_REPO ${DRONE_REPO}\n
      DRONE_REPO_BRANCH ${DRONE_REPO_BRANCH}\n
      DRONE_REMOTE_URL ${DRONE_REMOTE_URL}\n
      DRONE_REPO_LINK ${DRONE_REPO_LINK}\n
      DRONE_REPO_NAME ${DRONE_REPO_NAME}\n
      DRONE_REPO_NAMESPACE ${DRONE_REPO_NAMESPACE}\n
      DRONE_REPO_PRIVATE ${DRONE_REPO_PRIVATE}\n
      DRONE_REPO_SCM ${DRONE_REPO_SCM}\n
      DRONE_REPO_VISIBILITY ${DRONE_REPO_VISIBILITY}\n
      DRONE_RUNNER_HOST ${DRONE_RUNNER_HOST}\n
      DRONE_RUNNER_HOSTNAME ${DRONE_RUNNER_HOSTNAME}\n
      DRONE_RUNNER_PLATFORM ${DRONE_RUNNER_PLATFORM}\n
      DRONE_SOURCE_BRANCH ${DRONE_SOURCE_BRANCH}\n
      DRONE_SYSTEM_HOST ${DRONE_SYSTEM_HOST}\n
      DRONE_SYSTEM_HOSTNAME ${DRONE_SYSTEM_HOSTNAME}\n
      DRONE_RUNNER_LABEL ${DRONE_RUNNER_LABEL}\n
      DRONE_SYSTEM_VERSION ${DRONE_SYSTEM_VERSION}\n
      DRONE_TAG ${DRONE_TAG}\n
      DRONE_TARGET_BRANCH ${DRONE_TARGET_BRANCH}\n" > /var/local/drone/reports/${DRONE_REPO}/${DRONE_BUILD_NUMBER}/config

  - name: build
    image: ubuntu
    depends_on: [ prepare ]
    commands:
      - apt-get update && apt-get install -y git cmake gcc g++
      - cmake -DCMAKE_BUILD_TYPE=Debug -G "CodeBlocks - Unix Makefiles"
      - make MqttSnClientNetworkInterfaceUnitTests
      - make MqttSnGatewayNetworkInterfaceUnitTests
      - make MqttSnFixedSizeRingBufferUnitTests
      - make MqttSnForwarderIntegrationTests
      - make MqttSnForwarderLinuxTcpClientNetworkTests
      - make MqttSnForwarderLinuxTcpGatewayNetworkTests
      - cp MqttSnForwarderLinuxTcpClientNetworkTests MqttSnClientNetworkInterfaceMessageDefragmentationTests
      - cp MqttSnForwarderLinuxTcpClientNetworkTests SendMultipleClientMultipleMessageVariableLength
      - cp MqttSnForwarderLinuxTcpClientNetworkTests ReceiveMultipleClientMultipleMessageVariableLength
      - cp MqttSnForwarderLinuxTcpClientNetworkTests SendToClientsReceiveOnForwarderTests
      - cp MqttSnForwarderLinuxTcpClientNetworkTests ReceiveOnForwarderSendToClientTests
      - cp MqttSnForwarderLinuxTcpGatewayNetworkTests GatewayDefragmentationTests
      - cp MqttSnForwarderLinuxTcpGatewayNetworkTests SendToGateway
      - cp MqttSnForwarderLinuxTcpGatewayNetworkTests ReceiveFromGateway
      - cp MqttSnForwarderLinuxTcpGatewayNetworkTests SendToGatewayReceiveOnForwarder
      - cp MqttSnForwarderLinuxTcpGatewayNetworkTests ReceiveFromGatewaySendToGateway

  - name: MqttSnClientNetworkInterfaceUnitTests
    image: ubuntu
    depends_on: [ build ]
    commands:
      - ./MqttSnClientNetworkInterfaceUnitTests --gtest_filter=* --gtest_color=yes

  - name: MqttSnGatewayNetworkInterfaceUnitTests
    image: ubuntu
    depends_on: [ build ]
    commands:
      - ./MqttSnGatewayNetworkInterfaceUnitTests --gtest_filter=* --gtest_color=yes

  - name: MqttSnFixedSizeRingBufferUnitTests
    image: ubuntu
    depends_on: [ build ]
    commands:
      - ./MqttSnFixedSizeRingBufferUnitTests --gtest_filter=* --gtest_color=yes

  - name: MqttSnForwarderIntegrationTests
    image: ubuntu
    depends_on: [ build ]
    commands:
      - ./MqttSnForwarderIntegrationTests --gtest_color=yes


  - name: MqttSnClientNetworkInterfaceMessageDefragmentationTests
    image: ubuntu
    depends_on: [ MqttSnClientNetworkInterfaceUnitTests, MqttSnGatewayNetworkInterfaceUnitTests, MqttSnFixedSizeRingBufferUnitTests, MqttSnForwarderIntegrationTests ]
    commands:
      - ./MqttSnClientNetworkInterfaceMessageDefragmentationTests --gtest_filter=DefragmentationTests/MqttSnClientNetworkInterfaceMessageDefragmentationTests.*/*:DefragmentationTests/MqttSnClientNetworkInterfaceMessageDefragmentationTests/*.* --gtest_color=no

  - name: SendMultipleClientMultipleMessageVariableLength
    image: ubuntu
    depends_on: [ MqttSnClientNetworkInterfaceMessageDefragmentationTests ]
    commands:
      - ./SendMultipleClientMultipleMessageVariableLength --gtest_filter=MqttSnClientNetworkInterfaceTests.SendMultipleClientMultipleMessageVariableLength:MqttSnClientNetworkInterfaceTests/*.SendMultipleClientMultipleMessageVariableLength:*/MqttSnClientNetworkInterfaceTests.SendMultipleClientMultipleMessageVariableLength/*:*/MqttSnClientNetworkInterfaceTests/*.SendMultipleClientMultipleMessageVariableLength --gtest_color=yes

  - name: ReceiveMultipleClientMultipleMessageVariableLength
    image: ubuntu
    depends_on: [ MqttSnClientNetworkInterfaceMessageDefragmentationTests ]
    commands:
      - ./ReceiveMultipleClientMultipleMessageVariableLength --gtest_filter=MqttSnClientNetworkInterfaceTests.ReceiveMultipleClientMultipleMessageVariableLength:MqttSnClientNetworkInterfaceTests/*.ReceiveMultipleClientMultipleMessageVariableLength:*/MqttSnClientNetworkInterfaceTests.ReceiveMultipleClientMultipleMessageVariableLength/*:*/MqttSnClientNetworkInterfaceTests/*.ReceiveMultipleClientMultipleMessageVariableLength --gtest_color=yes

  - name: SendToClientsReceiveOnForwarderTests
    image: ubuntu
    depends_on: [ MqttSnClientNetworkInterfaceMessageDefragmentationTests ]
    commands:
      - ./SendToClientsReceiveOnForwarderTests --gtest_filter=MqttSnClientNetworkInterfaceTests.SendToClientsReceiveOnForwarderTests:MqttSnClientNetworkInterfaceTests/*.SendToClientsReceiveOnForwarderTests:*/MqttSnClientNetworkInterfaceTests.SendToClientsReceiveOnForwarderTests/*:*/MqttSnClientNetworkInterfaceTests/*.SendToClientsReceiveOnForwarderTests --gtest_color=no

  - name: ReceiveOnForwarderSendToClientTests
    image: ubuntu
    depends_on: [ MqttSnClientNetworkInterfaceMessageDefragmentationTests ]
    commands:
      - ./ReceiveOnForwarderSendToClientTests --gtest_filter=MqttSnClientNetworkInterfaceTests.ReceiveOnForwarderSendToClientTests:MqttSnClientNetworkInterfaceTests/*.ReceiveOnForwarderSendToClientTests:*/MqttSnClientNetworkInterfaceTests.ReceiveOnForwarderSendToClientTests/*:*/MqttSnClientNetworkInterfaceTests/*.ReceiveOnForwarderSendToClientTests --gtest_color=no


  - name: GatewayDefragmentationTests
    image: ubuntu
    depends_on: [ MqttSnClientNetworkInterfaceUnitTests, MqttSnGatewayNetworkInterfaceUnitTests, MqttSnFixedSizeRingBufferUnitTests, MqttSnForwarderIntegrationTests ]
    commands:
      - ./GatewayDefragmentationTests --gtest_filter=GatewayDefragmentationTests/MqttSnGatewayNetworkInterfaceMessageDefragmentationTests.*/*:GatewayDefragmentationTests/MqttSnGatewayNetworkInterfaceMessageDefragmentationTests/*.* --gtest_color=no

  - name: SendToGateway
    image: ubuntu
    depends_on: [ GatewayDefragmentationTests ]
    commands:
      - ./SendToGateway --gtest_filter=MqttSnGatewayNetworkInterfaceSendReceiveTests.SendToGateway:MqttSnGatewayNetworkInterfaceSendReceiveTests/*.SendToGateway:*/MqttSnGatewayNetworkInterfaceSendReceiveTests.SendToGateway/*:*/MqttSnGatewayNetworkInterfaceSendReceiveTests/*.SendToGateway --gtest_color=no

  - name: ReceiveFromGateway
    image: ubuntu
    depends_on: [ GatewayDefragmentationTests ]
    commands:
      - ./ReceiveFromGateway --gtest_filter=MqttSnGatewayNetworkInterfaceSendReceiveTests.ReceiveFromGateway:MqttSnGatewayNetworkInterfaceSendReceiveTests/*.ReceiveFromGateway:*/MqttSnGatewayNetworkInterfaceSendReceiveTests.ReceiveFromGateway/*:*/MqttSnGatewayNetworkInterfaceSendReceiveTests/*.ReceiveFromGateway --gtest_color=no

  - name: SendToGatewayReceiveOnForwarder
    image: ubuntu
    depends_on: [ GatewayDefragmentationTests ]
    commands:
      - ./SendToGatewayReceiveOnForwarder --gtest_filter=MqttSnGatewayNetworkInterfaceSendReceiveTests.SendToGatewayReceiveOnForwarder:MqttSnGatewayNetworkInterfaceSendReceiveTests/*.SendToGatewayReceiveOnForwarder:*/MqttSnGatewayNetworkInterfaceSendReceiveTests.SendToGatewayReceiveOnForwarder/*:*/MqttSnGatewayNetworkInterfaceSendReceiveTests/*.SendToGatewayReceiveOnForwarder --gtest_color=no

  - name: ReceiveFromGatewaySendToGateway
    image: ubuntu
    depends_on: [ GatewayDefragmentationTests ]
    commands:
      - ./ReceiveFromGatewaySendToGateway --gtest_filter=MqttSnGatewayNetworkInterfaceSendReceiveTests.ReceiveFromGatewaySendToGateway:MqttSnGatewayNetworkInterfaceSendReceiveTests/*.ReceiveFromGatewaySendToGateway:*/MqttSnGatewayNetworkInterfaceSendReceiveTests.ReceiveFromGatewaySendToGateway/*:*/MqttSnGatewayNetworkInterfaceSendReceiveTests/*.ReceiveFromGatewaySendToGateway --gtest_color=no

volumes:
  - name: reports
    host:
      path: /var/local/drone/reports
